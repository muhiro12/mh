#!/usr/bin/env zsh
# ------------------------------------------------------------
#  mh â€“ Minimal Git / GitHub helper
# ------------------------------------------------------------
set -euo pipefail
fatal(){ print -u2 "âŒ $*"; exit 1 }
note (){ print "ğŸ”¹ $*" }

# ---------- â¶ é–¢æ•° ------------------------------------------

install_gh() {
  if command -v gh >/dev/null; then
    note "`gh` ã¯æ—¢ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿"
  else
    command -v brew >/dev/null || fatal "Homebrew ãŒå¿…è¦ã§ã™: https://brew.sh"
    note "â¬ gh ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­â€¦"
    brew install gh
  fi
  note "âœ… gh æº–å‚™å®Œäº† (`gh --version | head -1`)"
}

detect_xcode() {
  setopt localoptions null_glob
  local workspace='' project=''
  for w in *.xcworkspace; do workspace=$w; break; done
  for p in *.xcodeproj;   do project=$p; break; done
  [[ $workspace || $project ]] || fatal ".xcworkspace / .xcodeproj ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"

  if [[ -z ${SCHEME:-} ]]; then
    local -a list
    [[ $workspace ]] && list=(-workspace "$workspace") || list=(-project "$project")
    SCHEME=$(xcodebuild $list -list 2>/dev/null |
             awk '/Schemes:/ {f=1;next} f&&NF{print;exit}' | xargs)
  fi
  [[ $SCHEME ]] || fatal "Scheme è‡ªå‹•ç‰¹å®šå¤±æ•—ã€‚SCHEME=â€¦ ã§æŒ‡å®šå¯"

  local sim_name
  sim_name=$(xcrun simctl list devices available |
             grep -Eo 'iPhone [^()]+' | head -n1 | xargs)
  DEST="platform=iOS Simulator,OS=latest,name=${sim_name}"

  typeset -ga TARGET=()
  [[ $workspace ]] && TARGET+=(-workspace "$workspace")
  [[ $project   ]] && TARGET+=(-project  "$project")
}

build_or_test() {
  detect_xcode
  note "ğŸ— ${TARGET[*]} | ğŸ“› $SCHEME | ğŸ“± $DEST"

  # ä¸€æ„ãªä¸€æ™‚ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®‰å…¨ã«ç”Ÿæˆ
  local log=$(mktemp -t mh_build)

  # â‘  test
  if xcodebuild $TARGET -scheme "$SCHEME" -destination "$DEST" test >"$log" 2>&1; then
    note "âœ… ãƒ†ã‚¹ãƒˆæˆåŠŸ"
    rm -f "$log"; return 0
  fi

  # â‘¡ build ã®ã¿
  note "â„¹ï¸ ãƒ†ã‚¹ãƒˆç„¡/å¤±æ•— â†’ build ã®ã¿å†è©¦è¡Œ"
  if xcodebuild $TARGET -scheme "$SCHEME" -destination "$DEST" build >"$log" 2>&1; then
    note "âœ… ãƒ“ãƒ«ãƒ‰æˆåŠŸï¼ˆãƒ†ã‚¹ãƒˆãªã—ï¼‰"
    rm -f "$log"; return 0
  fi

  # â‘¢ å¤±æ•—ï¼šæœ«å°¾ 20 è¡Œã ã‘è¡¨ç¤ºã—ã¦ãƒ­ã‚°å‰Šé™¤
  fatal "âŒ ãƒ“ãƒ«ãƒ‰å¤±æ•—\n$(tail -n 20 "$log")"
  rm -f "$log"
}

run_build() {
  note "ğŸ” ç¾åœ¨ãƒ–ãƒ©ãƒ³ãƒ: $(git rev-parse --abbrev-ref HEAD)"
  build_or_test
}

run_codex() {
  local pr=${1:-}
  gh auth status -h github.com >/dev/null || fatal "`gh auth login` ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"

  if [[ -z $pr ]]; then
    pr=$(gh pr list --state open --label codex --json number -q '.[0].number')
  fi
  [[ $pr ]] || fatal "Codex PR ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
  local title=$(gh pr view "$pr" --json title -q .title)

  note "â¡ï¸ PR #$pr Â«$titleÂ» ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ"
  gh pr checkout "$pr"

  build_or_test

  note "ğŸŸ¢ ãƒãƒ¼ã‚¸"
  gh pr merge "$pr" --rebase --delete-branch --auto

  local base=$(gh pr view "$pr" --json baseRefName -q .baseRefName)
  git checkout "$base"
  git pull --ff-only
  note "ğŸ‰ å®Œäº†: $base ã‚’æœ€æ–°ã«æ›´æ–°"
}

sync_main() {
  local dev_branch=${DEV_BRANCH:-develop}
  local main_branch=${MAIN_BRANCH:-main}

  note "â¡ï¸ $main_branch ã¸ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ"
  git checkout "$main_branch"

  note "ğŸ”„ $dev_branch ã‚’ fast-forward å–ã‚Šè¾¼ã¿"
  git pull --ff-only origin "$dev_branch"

  note "â¬†ï¸ Push $main_branch"
  git push origin "$main_branch"

  note "â†©ï¸ $dev_branch ã¸æˆ»ã‚‹"
  git checkout "$dev_branch"
  note "ğŸ‰ å®Œäº†: $main_branch ã‚’æœ€æ–° $dev_branch ã§æ›´æ–°ã—ã¾ã—ãŸ"
}

show_help() {
cat <<'EOS'
mh - Minimal helper

  -h, --help              ã“ã®ãƒ˜ãƒ«ãƒ—
  -i, --install           gh (GitHub CLI) ã‚’ Homebrew ã§å°å…¥
  -b, --build             ç¾åœ¨ãƒ–ãƒ©ãƒ³ãƒã‚’ build / test ã ã‘å®Ÿè¡Œ
  -c, --codex [<PR#>]     Codex PR â†’ build / test â†’ merge â†’ ãƒ™ãƒ¼ã‚¹æ›´æ–°
  -m, --main              main ã‚’ develop ã§ fast-forward ã—ã€push å¾Œ develop ã«æˆ»ã‚‹

ç’°å¢ƒå¤‰æ•°:
  SCHEME=<scheme>         Scheme è‡ªå‹•åˆ¤å®šã‚’ä¸Šæ›¸ã
  DEV_BRANCH=<name>       develop ä»¥å¤–ã‚’ä½¿ã†å ´åˆ
  MAIN_BRANCH=<name>      main ä»¥å¤–ã‚’ä½¿ã†å ´åˆ
EOS
}

# ---------- â· ãƒ¡ã‚¤ãƒ³ -----------------------------------------

ROOT=$(git -C . rev-parse --show-toplevel 2>/dev/null) ||
  fatal "Git ãƒªãƒã‚¸ãƒˆãƒªå¤–ã§ã™"
cd "$ROOT"

case "${1:-}" in
  -i|--install) install_gh ;;
  -b|--build)   run_build ;;
  -c|--codex)   shift; run_codex "$@" ;;
  -m|--main)    sync_main ;;
  -h|--help|*)  show_help ;;
esac

exit 0
