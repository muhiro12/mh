#!/usr/bin/env zsh
# ------------------------------------------------------------
#  mh â€“ Minimal Git / GitHub helper
# ------------------------------------------------------------

set -euo pipefail

# ============================================================
# ==  å…±é€šå‡¦ç† / Common Helpers
# ============================================================

fatal(){
  local code=1
  # If first arg is purely digits, treat it as exit code
  if [[ "$1" =~ ^[0-9]+$ ]]; then
    code=$1
    shift
  fi
  print -u2 "âŒ $*"
  exit $code
}

note (){
  print "ğŸ”¹ $*"
}

choose_target() {
  # Decide workspace / project once and export WORKSPACE / PROJECT vars
  setopt localoptions null_glob
  local repo_name=${PWD:t}
  WORKSPACE=''; PROJECT=''

  for w in *.xcworkspace; do
    [[ ${w:r} == "$repo_name" ]] && { WORKSPACE=$w; break; }
    [[ -z $WORKSPACE ]] && WORKSPACE=$w
  done
  for p in *.xcodeproj; do
    [[ ${p:r} == "$repo_name" ]] && { PROJECT=$p; break; }
    [[ -z $PROJECT ]] && PROJECT=$p
  done
}

merge_pr() {
  # Try auto-merge first; if repository disallows it, fall back to immediate mergeâ€‘commit
  local pr=$1
  if gh pr merge "$pr" --merge --delete-branch --auto >/dev/null 2>&1; then
    note "ğŸŸ¢ PR #$pr ã‚’ Autoâ€‘Merge ã«è¨­å®šã—ã¾ã—ãŸ"
  else
    note "â„¹ï¸ Autoâ€‘Merge ãŒç„¡åŠ¹ã®ãŸã‚é€šå¸¸ãƒãƒ¼ã‚¸ã‚’å®Ÿè¡Œ"
    gh pr merge "$pr" --merge --delete-branch \
      || fatal 9 "PR ãƒãƒ¼ã‚¸ã«å¤±æ•—ã—ã¾ã—ãŸ"
  fi
}

push_if_needed() {
  # Push current branch to origin if local != remote
  if [[ -n $(git status --porcelain --untracked-files=no) ]]; then
    fatal 6 "ã‚³ãƒŸãƒƒãƒˆã•ã‚Œã¦ã„ãªã„å¤‰æ›´ãŒã‚ã‚Šã¾ã™"
  fi
  if ! git diff --quiet @{u}; then
    note "â¬†ï¸ origin ã¸ push"
    git push -u origin "$(git rev-parse --abbrev-ref HEAD)" \
      || fatal 7 "push ã«å¤±æ•—ã—ã¾ã—ãŸ"
  fi
}

install_gh_core() {
  if command -v gh >/dev/null; then
    note "`gh` ã¯æ—¢ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿"
  else
    command -v brew >/dev/null || fatal "Homebrew ãŒå¿…è¦ã§ã™: https://brew.sh"
    note "â¬ gh ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­â€¦"
    brew install gh
  fi
  note "âœ… gh æº–å‚™å®Œäº† (`gh --version | head -1`)"
}

update_base_branch() {
  # $1 = PR number
  local pr=$1
  local base=$(gh pr view "$pr" --json baseRefName -q .baseRefName)
  git checkout "$base"
  git pull --ff-only
  note "ğŸ‰ å®Œäº†: $base ã‚’æœ€æ–°ã«æ›´æ–°"
}


detect_xcode() {
  choose_target
  local workspace=$WORKSPACE
  local project=$PROJECT
  [[ $workspace || $project ]] || fatal ".xcworkspace / .xcodeproj ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"

  if [[ -z ${SCHEME:-} ]]; then
    local -a list
    [[ $workspace ]] && list=(-workspace "$workspace") || list=(-project "$project")
    SCHEME=$(xcodebuild $list -list 2>/dev/null |
             awk '/Schemes:/ {f=1;next} f&&NF{print;exit}' | xargs)
  fi
  [[ $SCHEME ]] || fatal "Scheme è‡ªå‹•ç‰¹å®šå¤±æ•—ã€‚SCHEME=â€¦ ã§æŒ‡å®šå¯"

  local sim_name
  sim_name=$(xcrun simctl list devices available |
             grep -Eo 'iPhone [^()]+' | head -n1 | xargs)
  DEST="platform=iOS Simulator,OS=latest,name=${sim_name}"

  typeset -ga TARGET=()
  [[ $workspace ]] && TARGET+=(-workspace "$workspace")
  [[ $project   ]] && TARGET+=(-project  "$project")
}

open_xcode() {
  choose_target
  if [[ $WORKSPACE ]]; then
    note "ğŸ“‚ $WORKSPACE ã‚’ Xcode ã§é–‹ãã¾ã™"
    open "$WORKSPACE"
  elif [[ $PROJECT ]]; then
    note "ğŸ“‚ $PROJECT ã‚’ Xcode ã§é–‹ãã¾ã™"
    open "$PROJECT"
  else
    note "âš ï¸ Xcode ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
  fi
}

build_or_test() {
  detect_xcode
  note "ğŸ— ${TARGET[*]} | ğŸ“› $SCHEME | ğŸ“± $DEST"

  local log=$(mktemp -t mh_build)

  # â‘  å¸¸ã« test ã‚’è©¦è¡Œ
  if xcodebuild $TARGET -scheme "$SCHEME" -destination "$DEST" test >"$log" 2>&1 ; then
    note "âœ… ãƒ†ã‚¹ãƒˆæˆåŠŸ"
    rm -f "$log"; return 0
  fi

  # â‘¡ ãƒ†ã‚¹ãƒˆãªã—åˆ¤å®šï¼ˆã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã« 'No tests' ãŒå«ã¾ã‚Œã‚‹å ´åˆï¼‰
  if grep -qiE 'no tests? were found|Testing failed.*No tests' "$log"; then
    note "â„¹ï¸ ãƒ†ã‚¹ãƒˆãªã— â†’ build ã®ã¿å®Ÿè¡Œ"
    if xcodebuild $TARGET -scheme "$SCHEME" -destination "$DEST" build >>"$log" 2>&1 ; then
      note "âœ… ãƒ“ãƒ«ãƒ‰æˆåŠŸï¼ˆãƒ†ã‚¹ãƒˆãªã—ï¼‰"
      rm -f "$log"; return 0
    fi
  fi

  # â‘¢ å¤±æ•—ï¼šXcode ã‚’é–‹ãã€exit code 2
  open_xcode
  fatal 2 "âŒ ãƒ“ãƒ«ãƒ‰/ãƒ†ã‚¹ãƒˆå¤±æ•—\n$(tail -n 20 \"$log\")"
}

# ============================================================
# ==  ã‚³ãƒãƒ³ãƒ‰å®Ÿè£… / Command Implementations
# ============================================================

run_build() {
  note "ğŸ” ç¾åœ¨ãƒ–ãƒ©ãƒ³ãƒ: $(git rev-parse --abbrev-ref HEAD)"
  build_or_test
}

run_codex() {
  # Modes:
  #   normal : fetch PR then build/test/merge
  #   resume : assume we're already on the PR branch, build/test/merge only
  local resume=0
  if [[ "${1:-}" == "-r" || "${1:-}" == "--resume" ]]; then
    resume=1
    shift
  fi

  local pr
  if (( resume == 0 )); then
    # ----- normal mode -----
    pr=${1:-}
    if [[ -z $pr ]]; then
      pr=$(gh pr list --state open --label codex --json number -q '.[0].number')
    fi
    [[ $pr ]] || fatal "Codex PR ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"

    local title=$(gh pr view "$pr" --json title -q .title)
    note "â¡ï¸ PR #$pr Â«$titleÂ» ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ"
    gh pr checkout "$pr"
  else
    # ----- resume mode -----
    note "ğŸ”„ resume ãƒ¢ãƒ¼ãƒ‰: ç¾åœ¨ãƒ–ãƒ©ãƒ³ãƒã§å†ãƒ“ãƒ«ãƒ‰"
    pr=$(gh pr view --json number -q .number) \
      || fatal 8 "ã“ã®ãƒ–ãƒ©ãƒ³ãƒã«ç´ã¥ã PR ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
  fi

  build_or_test

  push_if_needed

  note "ğŸŸ¢ ãƒãƒ¼ã‚¸"
  merge_pr "$pr"

  update_base_branch "$pr"
}

run_install() {
  install_gh_core
}

run_main() {
  local dev_branch=${DEV_BRANCH:-develop}
  local main_branch=${MAIN_BRANCH:-main}

  note "â¡ï¸ $main_branch ã¸ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ"
  git checkout "$main_branch"

  note "ğŸ”„ $dev_branch ã‚’ fast-forward å–ã‚Šè¾¼ã¿"
  git pull --ff-only origin "$dev_branch"

  note "â¬†ï¸ Push $main_branch"
  git push origin "$main_branch"

  note "â†©ï¸ $dev_branch ã¸æˆ»ã‚‹"
  git checkout "$dev_branch"
  note "ğŸ‰ å®Œäº†: $main_branch ã‚’æœ€æ–° $dev_branch ã§æ›´æ–°ã—ã¾ã—ãŸ"
}

run_update() {
  #   mh -u           â†’ GitHub raw ã‚’ ~/bin/mh ã¸
  #   mh -u -l        â†’ ./mh ã‚’ ~/bin/mh ã¸ã‚³ãƒ”ãƒ¼
  local use_local=0
  if [[ "${1:-}" == "-l" || "${1:-}" == "--local" ]]; then
    use_local=1
  fi

  local BIN="$HOME/bin/mh"
  local RAW_URL="https://raw.githubusercontent.com/muhiro12/mh/refs/heads/main/mh"

  if (( use_local )); then
    [[ -f ./mh ]] || fatal 3 "./mh ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
    cp ./mh "$BIN" || fatal 3 "ã‚³ãƒ”ãƒ¼å¤±æ•—"
  else
    curl -fsSL "$RAW_URL" -o "$BIN" || fatal 4 "mh ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—"
  fi

  chmod 755 "$BIN"
  note "âœ… $BIN ã‚’æ›´æ–°ã—ã¾ã—ãŸ"
}

# ============================================================
# ==  ãƒ˜ãƒ«ãƒ— / Help
# ============================================================

run_help() {
cat <<'EOS'
mh - Minimal helper

  -b, --build             ç¾åœ¨ãƒ–ãƒ©ãƒ³ãƒã‚’ build / test ã ã‘å®Ÿè¡Œ
  -c, --codex [-r|--resume] [<PR#>] Codex PR ã‚’ build / test â†’ merge â†’ ãƒ™ãƒ¼ã‚¹æ›´æ–°
  -i, --install           gh (GitHub CLI) ã‚’ Homebrew ã§å°å…¥
  -m, --main              main ã‚’ develop ã§ fast-forward ã—ã€push å¾Œ develop ã«æˆ»ã‚‹
  -u, --update [-l|--local] GitHub ç‰ˆ (ã¾ãŸã¯ -l / --local ã§ ./mh) ã‚’ ~/bin/mh ã«åæ˜ 
  -h, --help              ã“ã®ãƒ˜ãƒ«ãƒ—

ç’°å¢ƒå¤‰æ•°:
  SCHEME=<scheme>         Scheme è‡ªå‹•åˆ¤å®šã‚’ä¸Šæ›¸ã
  DEV_BRANCH=<name>       develop ä»¥å¤–ã‚’ä½¿ã†å ´åˆ
  MAIN_BRANCH=<name>      main ä»¥å¤–ã‚’ä½¿ã†å ´åˆ
EOS
}

# ============================================================
# ==  ã‚³ãƒãƒ³ãƒ‰åˆ—æŒ™ / Main Dispatch
# ============================================================

ROOT=$(git -C . rev-parse --show-toplevel 2>/dev/null) ||
  fatal "Git ãƒªãƒã‚¸ãƒˆãƒªå¤–ã§ã™"
cd "$ROOT"

case "${1:-}" in
  -b|--build)   run_build ;;              # B
  -c|--codex)   shift; run_codex "$@" ;;  # C
  -i|--install) run_install ;;            # I
  -m|--main)    run_main ;;               # M
  -u|--update)  shift; run_update "$@" ;; # U
  -h|--help|*)  run_help ;;               # help (last)
esac

exit 0
